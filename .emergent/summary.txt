<analysis>**original_problem_statement:**
The user wants to create a comprehensive web application MVP called GradeSense, an AI-powered grading tool for handwritten answer papers.

**PRODUCT REQUIREMENTS:**
-   **Palette:** Orange and white, clean, modern, professional design. Desktop-first layout.
-   **Authentication:** Separate login for Teacher and Student.
-   **Teacher UI:**
    -   Comprehensive dashboards for class management, paper grading, reviewing results, and generating reports.
    -   Features include: AI-powered grading, student/batch/exam management, an LLM feedback loop, and advanced analytics.
-   **Student UI:**
    -   Dashboards to view results and track performance.
-   **Key Features from User:**
    -   The system must handle documents of any page length, specifically scaling to 30+ long papers simultaneously.
    -   The system must automatically extract the entire question structure from an uploaded paper.
    -   A new interactive Data Studio analytics page with drill-down capabilities and a natural language query feature (Ask Your Data).
    -   A new Heads-Up Display on the dashboard with actionable, teacher-centric cards.
    -   The Improve AI Grading feature must support feedback for specific sub-questions.
    -   The Improve AI Grading feature must allow providing feedback for multiple sub-questions in a single submission.

**User's preferred language**: English

**what currently exists?**
GradeSense is a full-stack React/FastAPI/MongoDB application. The UI has been enhanced with an interactive Data Studio analytics page, an actionable Heads-Up Display on the dashboard, and a sophisticated Improve AI modal that allows for multi-part corrections.

The core challenge revolves around the batch grading feature. An asynchronous background job system was implemented to handle large-scale grading (30+ papers), but it is currently broken. The system incorrectly signals that grading has started, while no papers are actually processed due to a fundamental issue with how files are handled between the web server and the background worker.

**Last working item**:
The agent was in the middle of a critical fix for the broken background grading system. After realizing that passing temporary  objects to a background task was causing the process to fail (as the files were deleted before being read), the agent started to revert to a slower, but more reliable, implementation. This involves reading the file contents into memory within the API endpoint *before* starting the background job.

-   **Last item agent was working:** Reverting the logic in  and . The agent has applied the initial edits but noted that more logic, specifically a  block and other code, still needed to be fixed in  to complete the revert.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** Both. First, manually test the backend by uploading 2-3 papers and monitoring  to confirm the job processes them. Then, use the frontend testing agent to verify the entire end-to-end flow, including the progress bar and result display.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Background grading system is non-functional (P0)**
-   **Issue 2: User verification for new Improve AI features (P1)**
-   **Issue 3: User verification for question text extraction fix (P2)**
-   **Issue 4: User verification for Topic Mastery visualization fix (P2)**

**Issues Detail:**
-   **Issue 1:**
    -   **Description:** When a user uploads multiple papers, the UI immediately returns a success message, but the background grading job fails silently, and no papers are graded. This is because the background task tries to access  objects after the HTTP request has already closed, making the files inaccessible.
    -   **Attempted fixes:** The agent is currently reverting to a previous, more stable approach: reading the full content of all uploaded files into memory within the  endpoint and passing this data to the background task.
    -   **Next debug checklist:**
        1.  Resume the fix in . The agent's last thought was to add a  block and fix the processing logic.
        2.  Ensure the  function correctly receives and processes a list of dictionaries containing file content, not  objects.
        3.  Verify the endpoint in  is correctly reading the files and passing the data structure.
        4.  Restart the backend (backend: stopped
backend: started).
        5.  Test with a small batch of papers and confirm processing in the backend logs.
    -   **Why fix this issue and what will be achieved with the fix?** This is the application's most critical feature. Fixing it will restore the core functionality and unblock the user.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on other issue:** None. This is the primary blocker.

**In progress Task List**:
-   **Task 1: Complete the Revert of the Background Grading Logic (P0)**
    -   **Where to resume:** In , complete the logic changes to align with the reverted approach of receiving file contents instead of file objects. This includes ensuring  blocks and data handling are correct.
    -   **What will be achieved with this?** A functional, reliable, albeit slower, batch grading system.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on something:** Nothing.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P1: Optimize File Reading Concurrently:** After the revert stabilizes the system, optimize the initial file-reading step. Use  in the endpoint to read all uploaded files concurrently, which will significantly reduce the initial wait time for the user.
    -   **P2: Full User Verification Cycle:** The user needs to test all the recently added features, which are currently unverified:
        -   The multi-sub-question correction feature in Improve AI.
        -   The fix for displaying full question text.
        -   The updated Heads-Up dashboard cards.
-   **Future Tasks:**
    -   **P3: Refactor :** The backend file is over 8000 lines long and urgently needs to be broken down into a structured format (e.g., , , ) to improve maintainability.
    -   **P4: Pagination/Virtualization:** Implement for large lists in .
    -   **P5: Student Re-evaluation Requests:** Allow students to request reviews.
    -   **P6: Email Notifications:** Notify students upon result publication.

**Completed work in this session**
-   **New Feature - Improve AI Multi-Correction UI:** Implemented a new modal UI allowing teachers to provide feedback on multiple sub-questions at once and submit them in a single batch for intelligent re-grading.
-   **Bug Fix - Improve AI Modal UI:** Made the feedback modal wider and scrollable to prevent the submit button from being cut off on smaller screens.
-   **Bug Fix - Question Text Extraction:** Corrected the question extraction logic to ensure  and their text are properly saved to the database.
-   **Critical Bug Investigation:** Diagnosed the root cause of the background grading failure (invalid file handles in background tasks) and initiated a revert to a stable implementation.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Analytics features are broken.
-   **Recurrence count:** 2+
-   **Status:** RESOLVED. The analytics module was completely rebuilt and is pending user verification.

**Code Architecture**


**Key Technical Concepts**
-   **Asynchronous Background Tasks:** Using FastAPI's background tasks to run long-running grading jobs. The key learning is that  objects cannot be passed directly to these tasks; their content must be read first.
-   **Intelligent Re-grading:** A feature that uses an LLM, prompted with teacher feedback, to re-evaluate and re-score student answers for all papers in a batch.
-   **Complex Frontend State Management:** The Improve AI modal in  now manages an array of correction objects, each with its own state, to support the multi-correction feature.

**All files of reference**
-   **/app/backend/server.py**: The core of the application. Contains the  endpoint that is being fixed.
-   **/app/backend/background_grading.py**: Contains the  worker function, which is also being reverted and fixed.
-   **/app/frontend/src/pages/teacher/UploadGrade.jsx**: Initiates grading and polls for status.
-   **/app/frontend/src/pages/teacher/ReviewPapers.jsx**: Contains the heavily modified Improve AI modal for submitting single and multiple corrections.

**Areas that need refactoring**:
-   **/app/backend/server.py**: This file's size is a critical risk. It makes debugging difficult and new feature implementation error-prone. It must be broken into a proper project structure (routes, services, models).
-   **/app/frontend/src/pages/teacher/ReviewPapers.jsx**: The logic for the Improve AI modal is now very complex and should be extracted into its own dedicated component to simplify the page.

**key api endpoints**
-   : **(BROKEN, IN DEBUG)** The endpoint responsible for starting the background grading job.
-   : Polls for the status of a grading job.
-   : **(NEW)** The endpoint that receives and processes multiple corrections for intelligent re-grading across a batch.

**Critical Info for New Agent**
1.  **Your #1 Priority is Fixing the Grading System:** The main feature of the app is broken. You must complete the revert that the previous agent started. This involves ensuring files are read into memory *within* the API endpoint before the background task is created.
2.  **Resume the Revert:** The previous agent stopped mid-fix. You need to resume work on , ensuring its logic correctly handles receiving pre-read file content, not file objects. Review both  and  for consistency.
3.  **File Lifecycle is the Root Cause:** Remember that FastAPI  objects are temporary and tied to the request lifecycle. They become invalid once the endpoint returns a response. The entire fix is based on working around this limitation.
4.  **Defer Optimization:** The plan to optimize file reading with  is for *after* the system is stable. Do not attempt this optimization until the basic revert is fully tested and working.

**Project Health Check:**
-   **Broken:** The core batch grading functionality is non-operational. This is a critical failure.
-   **Mocked:** N/A

**3rd Party Integrations**
-   **Google Gemini 2.5 Flash:** Powers all AI features. Uses the Emergent LLM Key.
-   **Emergent-managed Google Auth:** Handles user authentication.
-   **Google Analytics (GA4):** Integrated for usage tracking.

**Testing status**
-   **Testing agent used after significant changes:** NO (for the latest fix attempts).
-   **Troubleshoot agent used after agent stuck in loop:** YES.
-   **Test files created:** None.
-   **Known regressions:** The entire background grading system has regressed to a non-functional state.

**What agent forgot to execute**
The agent did not complete the revert of the background grading logic. The files  and  were edited, but the agent's own notes indicate that the logic in  is incomplete and requires further modification to be functional.</analysis>
